<script>
const STATUS_CONFIG = {
  DRAFT: {
    color: 'gray',
    label: 'Draft',
    actions: ['SENT']
  },
  SENT: {
    color: 'blue',
    label: 'Sent',
    actions: ['DELIVERED']
  },
  DELIVERED: {
    color: 'green',
    label: 'Delivered',
    actions: ['READ']
  },
  READ: {
    color: 'purple',
    label: 'Read',
    actions: ['REPLIED']
  },
  REPLIED: {
    color: 'indigo',
    label: 'Replied',
    actions: []
  },
  FAILED: {
    color: 'red',
    label: 'Failed',
    actions: ['DRAFT']
  }
};

const CommunicationTemplates = {
  ESTIMATE_FOLLOWUP: {
    subject: 'Follow-up: Estimate #{estimateId}',
    content: `Dear {customerName},

We wanted to follow up regarding estimate #{estimateId} sent on {dateSent}.

{customContent}

Best regards,
{senderName}`
  },
  PAYMENT_REMINDER: {
    subject: 'Payment Reminder: Invoice #{invoiceId}',
    content: `Dear {customerName},

This is a friendly reminder that invoice #{invoiceId} for {amount} is due on {dueDate}.

{customContent}

Best regards,
{senderName}`
  },
  STATUS_UPDATE: {
    subject: 'Project Status Update: {projectName}',
    content: `Dear {customerName},

Here's an update on your project: {projectName}

{customContent}

Best regards,
{senderName}`
  }
};

const MessageForm = ({ onSubmit, onCancel, initialData = {} }) => {
  const [formData, setFormData] = React.useState({
    type: initialData.type || window.CONSTANTS.CUSTOMER_MODULE.DOCUMENT_TYPES.COMMUNICATION,
    subject: initialData.subject || '',
    content: initialData.content || '',
    sentTo: initialData.sentTo || customer.contactEmail,
    status: window.CONSTANTS.COMMUNICATION_STATUSES.DRAFT,
    channel: initialData.channel || customer.preferredChannel || 'EMAIL',
    priority: initialData.priority || 'NORMAL',
    template: initialData.template || ''
  });

  const handleTemplateSelect = (templateId) => {
    const template = CommunicationTemplates[templateId];
    if (template) {
      setFormData(prev => ({
        ...prev,
        subject: template.subject,
        content: template.content
      }));
    }
  };

  return React.createElement('form', {
    onSubmit: (e) => {
      e.preventDefault();
      onSubmit(formData);
    },
    className: 'space-y-4'
  }, [
    // Template selector
    React.createElement('div', null, [
      React.createElement('label', {
        className: 'block text-sm font-medium text-gray-700'
      }, 'Template'),
      React.createElement('select', {
        value: formData.template,
        onChange: (e) => handleTemplateSelect(e.target.value),
        className: 'mt-1 block w-full rounded-md border-gray-300 shadow-sm'
      }, [
        React.createElement('option', { value: '' }, 'Select a template...'),
        Object.keys(CommunicationTemplates).map(key =>
          React.createElement('option', { key, value: key }, key)
        )
      ])
    ]),
    // ... other form fields
  ]);
};

const CustomerCommunications = ({ customer, showMessage }) => {
  const [state, setState] = React.useState({
    communications: [],
    loading: true,
    error: null,
    showNewMessageForm: false,
    newMessage: {
      type: window.CONSTANTS.COMMUNICATION_TYPES.STATUS_UPDATE,
      subject: '',
      content: '',
      sentTo: customer.contactEmail || '',
      status: window.CONSTANTS.COMMUNICATION_STATUSES.DRAFT,
      channel: 'EMAIL',
      priority: 'NORMAL',
      deliveryPreference: customer.preferredChannel || 'EMAIL'
    }
  });

  const mountedRef = React.useRef(true);

  React.useEffect(() => {
    if (!window.CONSTANTS.PERMISSIONS.CUSTOMER.communications?.view?.includes(
      window.CONSTANTS.USER_ROLE
    )) {
      setState(prev => ({ ...prev, error: 'Insufficient permissions', loading: false }));
      return;
    }
    loadCommunications();
    return () => {
      mountedRef.current = false;
    };
  }, [customer.CustomerID]);

  const loadCommunications = () => {
    if (!mountedRef.current) return;
    setState(prev => ({ ...prev, loading: true }));

    google.script.run
      .withSuccessHandler(result => {
        if (!mountedRef.current) return;
        setState(prev => ({
          ...prev,
          communications: result,
          loading: false
        }));
      })
      .withFailureHandler(error => {
        if (!mountedRef.current) return;
        setState(prev => ({
          ...prev,
          error: error.message || 'Failed to load communications',
          loading: false
        }));
        showMessage('Error loading communications', 'error');
      })
      .getCustomerCommunications(customer.CustomerID);
  };

  const logCommunicationActivity = async (action, details) => {
    await google.script.run
      .withFailureHandler(error => console.error('Activity log error:', error))
      .logActivity({
        action,
        moduleType: 'CUSTOMER_COMMUNICATIONS',
        referenceId: customer.CustomerID,
        details: {
          ...details,
          timestamp: new Date().toISOString()
        }
      });
  };

  const handleSendMessage = async (messageData) => {
    if (!mountedRef.current) return;
    setState(prev => ({ ...prev, loading: true }));

    try {
      await google.script.run
        .withSuccessHandler(() => {
          if (!mountedRef.current) return;
          loadCommunications();
          setState(prev => ({
            ...prev,
            showNewMessageForm: false,
            newMessage: { ...state.newMessage, subject: '', content: '' }
          }));
          
          // Log activity
          logCommunicationActivity('SEND_COMMUNICATION', {
            type: messageData.type,
            subject: messageData.subject,
            recipient: messageData.sentTo
          });
          
          showMessage('Message sent successfully', 'success');
        })
        .withFailureHandler(error => {
          throw error;
        })
        .sendCustomerCommunication({
          ...messageData,
          CustomerID: customer.CustomerID,
          CreatedBy: Session.getActiveUser().getEmail()
        });
    } catch (error) {
      if (!mountedRef.current) return;
      setState(prev => ({ ...prev, loading: false }));
      showMessage(error.message || 'Failed to send message', 'error');
    }
  };

  return React.createElement('div', { className: 'space-y-6' }, [
    React.createElement('div', {
      className: 'flex justify-between items-center mb-6'
    }, [
      React.createElement('h2', {
        className: 'text-2xl font-bold text-gray-900'
      }, 'Communications'),
      React.createElement('button', {
        onClick: () => setState(prev => ({ ...prev, showNewMessageForm: true })),
        className: 'px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700'
      }, 'New Message')
    ]),

    state.loading ? React.createElement('div', {
      className: 'text-center py-4'
    }, 'Loading...') : state.error ? React.createElement('div', {
      className: 'text-red-600 bg-red-50 p-4 rounded-md'
    }, state.error) : React.createElement('div', {
      className: 'space-y-4'
    }, state.communications.map(comm =>
      React.createElement('div', {
        key: comm.CommunicationID,
        className: 'bg-white shadow-sm rounded-lg p-4'
      }, [
        React.createElement('div', {
          className: 'flex justify-between items-start'
        }, [
          React.createElement('div', null, [
            React.createElement('h3', {
              className: 'text-lg font-medium'
            }, comm.Subject),
            React.createElement('p', {
              className: 'text-sm text-gray-500'
            }, `Sent to: ${comm.SentTo}`)
          ]),
          React.createElement('span', {
            className: `px-2 inline-flex text-xs leading-5 font-semibold rounded-full
              ${comm.Status === 'SENT' ? 'bg-green-100 text-green-800' : 
                comm.Status === 'DRAFT' ? 'bg-yellow-100 text-yellow-800' : 
                'bg-gray-100 text-gray-800'}`
          }, comm.Status)
        ]),
        React.createElement('p', {
          className: 'mt-2 text-gray-700'
        }, comm.Content),
        React.createElement('div', {
          className: 'mt-4 flex justify-between items-center text-sm text-gray-500'
        }, [
          React.createElement('span', null, new Date(comm.CreatedOn).toLocaleString()),
          React.createElement('div', {
            className: 'flex space-x-4'
          }, [
            React.createElement('button', {
              onClick: () => handleReply(comm),
              className: 'text-blue-600 hover:text-blue-800'
            }, 'Reply'),
            React.createElement('button', {
              onClick: () => handleForward(comm),
              className: 'text-blue-600 hover:text-blue-800'
            }, 'Forward')
          ])
        ])
      ])
    ))
  ]);
};

window.CustomerCommunications = CustomerCommunications;
</script>