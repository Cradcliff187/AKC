<script>
if (typeof window.DebugTracer === 'undefined') {
  const DebugTracer = {
    componentStack: [],
    declarations: new Map(),
    
    init() {
      console.log('%c[DebugTracer] Initialization started', 'color: blue; font-weight: bold');
      
      // Wait for ComponentRegistry to be available
      const checkRegistry = setInterval(() => {
        if (window.ComponentRegistry) {
          clearInterval(checkRegistry);
          this.hookComponentRegistry();
          this.trackDeclarations();
          console.log('%c[DebugTracer] Successfully hooked into ComponentRegistry', 'color: green');
        }
      }, 100);
    },

    hookComponentRegistry() {
      if (!window.ComponentRegistry || !window.ComponentRegistry.register) {
        console.error('[DebugTracer] ComponentRegistry not found');
        return;
      }

      const originalRegister = window.ComponentRegistry.register;
      window.ComponentRegistry.register = (name, component) => {
        const stackTrace = new Error().stack;
        console.group(`%c[Component Registration] ${name}`, 'color: green');
        console.log('Registration location:', stackTrace.split('\n')[2].trim());
        console.log('Component structure:', Object.keys(component));
        
        if (this.declarations.has(name)) {
          console.warn(`%cDuplicate declaration detected for: ${name}`, 'color: red; font-weight: bold');
          console.log('Previous declaration at:', this.declarations.get(name));
          console.log('Current declaration at:', stackTrace);
        }
        
        this.declarations.set(name, stackTrace);
        console.groupEnd();
        
        return originalRegister.call(window.ComponentRegistry, name, component);
      };
    },

    trackGlobalDeclarations() {
      const trackedIdentifiers = ['const handleStatusChange = window.handleStatusChange;', 'StatusBadge', 'const STATUS_CONFIG = window.STATUS_CONFIG;'];
      
      trackedIdentifiers.forEach(identifier => {
        Object.defineProperty(window, identifier, {
          set: function(value) {
            console.group(`%c[Global Declaration] ${identifier}`, 'color: orange');
            console.log('Declaration location:', new Error().stack.split('\n')[2].trim());
            console.log('Value type:', typeof value);
            console.groupEnd();
            delete window[identifier];
            window[identifier] = value;
          },
          configurable: true
        });
      });
    },

    logError(error, context) {
      console.group('%c[Error Details]', 'color: red; font-weight: bold');
      console.log('Error type:', error.name);
      console.log('Message:', error.message);
      console.log('Location:', error.stack.split('\n')[1].trim());
      console.log('Context:', context);
      console.groupEnd();
    }
  };

  // Initialize tracer
  window.DebugTracer = DebugTracer;
  
  // Add error listeners
  window.addEventListener('error', (event) => {
    window.DebugTracer.logError(event.error, {
      filename: event.filename,
      line: event.lineno,
      column: event.colno
    });
  });

  // Start tracking declarations
  window.DebugTracer.trackGlobalDeclarations();
  
  // Initialize after brief delay to ensure DOM is ready
  setTimeout(() => window.DebugTracer.init(), 0);
}
</script>