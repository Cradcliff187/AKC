<script>
const CustomerFinancials = ({ customer, showMessage }) => {
  const [state, setState] = React.useState({
    loading: true,
    error: null,
    financials: {
      totalRevenue: 0,
      activeProjects: 0,
      paidInvoices: 0,
      outstandingInvoices: 0,
      revenueByYear: {},
      projectBreakdown: []
    }
  });

  const mountedRef = React.useRef(true);

  React.useEffect(() => {
    if (!CONSTANTS.PERMISSIONS.CUSTOMER.financials?.view?.includes(
      CONSTANTS.USER_ROLE
    )) {
      setState(prev => ({ ...prev, error: 'Insufficient permissions' }));
      return;
    }
    loadFinancials();
    return () => {
      mountedRef.current = false;
    };
  }, [customer.CustomerID]);

  const loadFinancials = async () => {
    if (!mountedRef.current) return;
    setState(prev => ({ ...prev, loading: true }));

    try {
      const [estimates, projects, invoices] = await Promise.all([
        google.script.run.withSuccessHandler(data => data).getCustomerEstimates(customer.CustomerID),
        google.script.run.withSuccessHandler(data => data).getCustomerProjects(customer.CustomerID),
        google.script.run.withSuccessHandler(data => data).getCustomerInvoices(customer.CustomerID)
      ]);

      if (!mountedRef.current) return;

      const revenueByYear = {};
      projects.forEach(project => {
        const year = new Date(project.CreatedOn).getFullYear();
        revenueByYear[year] = (revenueByYear[year] || 0) + (Number(project.TotalRevenue) || 0);
      });

      setState(prev => ({
        ...prev,
        loading: false,
        financials: {
          totalRevenue: projects.reduce((sum, p) => sum + (Number(p.TotalRevenue) || 0), 0),
          activeProjects: projects.filter(p => p.Status === 'IN_PROGRESS').length,
          paidInvoices: invoices.filter(i => i.Status === 'PAID').length,
          outstandingInvoices: invoices.filter(i => i.Status === 'PENDING').length,
          revenueByYear,
          projectBreakdown: projects.map(p => ({
            id: p.ProjectID,
            name: p.ProjectName,
            revenue: Number(p.TotalRevenue) || 0,
            status: p.Status
          }))
        }
      }));

      // Log activity
      await google.script.run.logActivity({
        action: 'VIEW_FINANCIALS',
        moduleType: 'CUSTOMER',
        referenceId: customer.CustomerID,
        details: { timestamp: new Date().toISOString() }
      });
    } catch (error) {
      if (!mountedRef.current) return;
      setState(prev => ({
        ...prev,
        loading: false,
        error: error.message || 'Failed to load financial data'
      }));
    }
  };

  const formatCurrency = (amount) => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD'
    }).format(amount);
  };

  if (state.error) {
    return React.createElement('div', {
      className: 'bg-red-50 text-red-600 p-4 rounded-md'
    }, state.error);
  }

  if (state.loading) {
    return React.createElement('div', {
      className: 'text-center py-4'
    }, 'Loading financial data...');
  }

  return React.createElement('div', { className: 'space-y-6' }, [
    // Financial Summary Cards
    React.createElement('div', {
      className: 'grid grid-cols-1 md:grid-cols-4 gap-4'
    }, [
      {
        title: 'Total Revenue',
        value: formatCurrency(state.financials.totalRevenue),
        color: 'green'
      },
      {
        title: 'Active Projects',
        value: state.financials.activeProjects,
        color: 'blue'
      },
      {
        title: 'Paid Invoices',
        value: state.financials.paidInvoices,
        color: 'green'
      },
      {
        title: 'Outstanding Invoices',
        value: state.financials.outstandingInvoices,
        color: 'yellow'
      }
    ].map(card => 
      React.createElement('div', {
        key: card.title,
        className: `bg-${card.color}-50 p-4 rounded-lg`
      }, [
        React.createElement('div', {
          className: 'text-sm text-gray-600'
        }, card.title),
        React.createElement('div', {
          className: `text-xl font-semibold text-${card.color}-700`
        }, card.value)
      ])
    )),

    // Project Breakdown
    React.createElement('div', {
      className: 'bg-white shadow rounded-lg overflow-hidden'
    }, [
      React.createElement('div', {
        className: 'px-4 py-5 sm:px-6'
      }, [
        React.createElement('h3', {
          className: 'text-lg font-medium text-gray-900'
        }, 'Project Breakdown')
      ]),
      React.createElement('div', {
        className: 'border-t border-gray-200'
      }, [
        React.createElement('table', {
          className: 'min-w-full divide-y divide-gray-200'
        }, [
          React.createElement('thead', {
            className: 'bg-gray-50'
          }, [
            React.createElement('tr', null, [
              'Project',
              'Status',
              'Revenue'
            ].map(header => 
              React.createElement('th', {
                key: header,
                className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider'
              }, header)
            ))
          ]),
          React.createElement('tbody', {
            className: 'bg-white divide-y divide-gray-200'
          }, state.financials.projectBreakdown.map(project => 
            React.createElement('tr', { key: project.id }, [
              React.createElement('td', {
                className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900'
              }, project.name),
              React.createElement('td', {
                className: 'px-6 py-4 whitespace-nowrap'
              }, React.createElement(StatusBadge, { status: project.status })),
              React.createElement('td', {
                className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500'
              }, formatCurrency(project.revenue))
            ])
          ))
        ])
      ])
    ])
  ]);
};

// Make available in both server and client contexts
if (typeof this !== 'undefined') {
  this.CustomerFinancials = CustomerFinancials;
}
</script>
