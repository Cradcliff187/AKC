<script>
const SubInvoice = ({ projectId, onBack }) => {
  const [state, setState] = React.useState({
    loading: false,
    error: null,
    success: null,
    subcontractors: [],
    invoices: [],
    form: {
      ProjectName: '',
      SubID: '',
      SubName: '',
      InvoiceAmount: '',
      InvoiceDocURL: '',
      fileUpload: null
    }
  });

  const mountedRef = React.useRef(true);

  React.useEffect(() => {
    if (!window.CONSTANTS.PERMISSIONS.PROJECT.subInvoices?.submit?.includes(
      window.CONSTANTS.USER_ROLE
    )) {
      setState(prev => ({ ...prev, error: 'Insufficient permissions' }));
      return;
    }
    loadSubcontractors();
    loadExistingInvoices();
    
    return () => {
      mountedRef.current = false;
    };
  }, [projectId]);

  // Local state for form management
  const [searchTerm, setSearchTerm] = React.useState('');
  const [filteredInvoices, setFilteredInvoices] = React.useState([]);
  const [selectedInvoice, setSelectedInvoice] = React.useState(null);

  const handleFileUpload = async (file) => {
    if (!file) return;
    
    const validTypes = ['application/pdf', 'image/jpeg', 'image/png'];
    if (!validTypes.includes(file.type)) {
      setState(prev => ({
        ...prev,
        error: 'Invalid file type. Please upload PDF or images only.'
      }));
      return;
    }
  
    const maxSize = 10 * 1024 * 1024; // 10MB
    if (file.size > maxSize) {
      setState(prev => ({
        ...prev,
        error: 'File size exceeds 10MB limit'
      }));
      return;
    }
  
    setState(prev => ({ ...prev, loading: true }));
  
    try {
      const reader = new FileReader();
      reader.onload = async (e) => {
        const base64Data = e.target.result.split(',')[1];
        
        const response = await google.script.run
          .withSuccessHandler(result => {
            if (!mountedRef.current) return;
            setState(prev => ({
              ...prev,
              form: {
                ...prev.form,
                InvoiceDocURL: result.url
              },
              loading: false
            }));
          })
          .withFailureHandler(error => {
            if (!mountedRef.current) return;
            setState(prev => ({
              ...prev,
              error: error.message,
              loading: false
            }));
          })
          .uploadReceiptFile({
            base64Data,
            folderId: projectId,
            fileType: file.type
          });
      };
      reader.readAsDataURL(file);
    } catch (error) {
      setState(prev => ({
        ...prev,
        error: 'Failed to upload file',
        loading: false
      }));
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    const { form } = state;
    if (!form.SubID || !form.InvoiceAmount) {
      setState(prev => ({
        ...prev,
        error: 'Please fill in all required fields'
      }));
      return;
    }
  
    setState(prev => ({ ...prev, loading: true }));
  
    try {
      await google.script.run
        .withSuccessHandler(() => {
          if (!mountedRef.current) return;
          
          // Log activity
          google.script.run.logActivity({
            action: 'SUBMIT_INVOICE',
            moduleType: 'SUBINVOICES',
            referenceId: projectId,
            details: {
              subId: form.SubID,
              amount: form.InvoiceAmount
            }
          });
  
          setState(prev => ({
            ...prev,
            loading: false,
            success: 'Invoice submitted successfully',
            form: {
              ProjectName: '',
              SubID: '',
              SubName: '',
              InvoiceAmount: '',
              InvoiceDocURL: '',
              fileUpload: null
            }
          }));
        })
        .withFailureHandler(error => {
          if (!mountedRef.current) return;
          setState(prev => ({
            ...prev,
            error: error.message,
            loading: false
          }));
        })
        .submitSubInvoice({
          ProjectID: projectId,
          ...form
        });
    } catch (error) {
      setState(prev => ({
        ...prev,
        error: 'Failed to submit invoice',
        loading: false
      }));
    }
  };

  return React.createElement('div', { className: 'space-y-6' }, [
    // Header Section
    React.createElement('div', {
      className: 'flex justify-between items-center mb-6'
    }, [
      React.createElement('h2', {
        className: 'text-2xl font-bold text-gray-900'
      }, 'Subcontractor Invoices'),
      React.createElement('button', {
        onClick: onBack,
        className: 'px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300'
      }, '← Back')
    ]),

    // Main Content Section
    React.createElement('div', {
      className: 'bg-white shadow rounded-lg p-6'
    }, [
      // Form fields matching blueprint SUBINVOICES schema
      React.createElement('form', {
        className: 'space-y-4',
        onSubmit: handleSubmit
      }, [
        React.createElement('input', {
          type: 'text',
          name: 'ProjectName',
          placeholder: 'Project Name',
          className: 'w-full px-3 py-2 border rounded-md'
        }),
        React.createElement('div', {
          className: 'grid grid-cols-2 gap-4'
        }, [
          React.createElement('input', {
            type: 'text',
            name: 'SubID',
            placeholder: 'Subcontractor ID',
            className: 'w-full px-3 py-2 border rounded-md'
          }),
          React.createElement('input', {
            type: 'text',
            name: 'SubName',
            placeholder: 'Subcontractor Name',
            className: 'w-full px-3 py-2 border rounded-md'
          })
        ]),
        React.createElement('input', {
          type: 'number',
          name: 'InvoiceAmount',
          placeholder: 'Invoice Amount',
          step: '0.01',
          min: '0',
          className: 'w-full px-3 py-2 border rounded-md'
        }),
        React.createElement('input', {
          type: 'text',
          name: 'InvoiceDocURL',
          placeholder: 'Invoice Document URL',
          className: 'w-full px-3 py-2 border rounded-md'
        }),
        React.createElement('div', {
          className: 'flex justify-end mt-4'
        }, [
          React.createElement('button', {
            type: 'submit',
            className: 'px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700'
          }, 'Submit Invoice')
        ])
      ])
    ])
  ]);
};

const MessageAlert = ({ type, message }) => {
  if (!message) return null;
  
  const styles = {
    error: 'bg-red-50 text-red-700 border-red-400',
    success: 'bg-green-50 text-green-700 border-green-400'
  };

  return React.createElement('div', {
    className: `p-4 mb-4 rounded border ${styles[type]}`
  }, message);
};

if (typeof this !== 'undefined') {
  this.SubInvoice = SubInvoice;
}
</script>