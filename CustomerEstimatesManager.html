<script>
import React, { useState, useEffect, useRef } from 'react';

const CustomerEstimatesManager = ({ customer, onBack, showMessage }) => {
  // Enhanced state management
  const [estimates, setEstimates] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedEstimate, setSelectedEstimate] = useState(null);
  const [isEditing, setIsEditing] = useState(false);
  const [filterStatus, setFilterStatus] = useState('all');
  const [emailDialogOpen, setEmailDialogOpen] = useState(false);
  
  const mountedRef = useRef(true);

  useEffect(() => {
    mountedRef.current = true;
    if (customer?.customerId) {
      loadEstimatesData();
    }
    return () => { mountedRef.current = false; };
  }, [customer?.customerId]);

  const loadEstimatesData = async () => {
    if (!mountedRef.current) return;
    setLoading(true);
    try {
      const response = await new Promise(resolve => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(err => resolve({ success: false, error: err.message }))
          .getCustomerEstimates(customer.customerId);
      });

      if (!mountedRef.current) return;

      if (response.success) {
        const processedData = processEstimates(response.data);
        setEstimates(processedData.estimates);
      } else {
        showMessage(response.error || 'Failed to load estimates', 'error');
      }
    } catch (error) {
      if (mountedRef.current) {
        showMessage('Failed to load estimates', 'error');
      }
    } finally {
      if (mountedRef.current) {
        setLoading(false);
      }
    }
  };

  const handleStatusUpdate = async (estimateId, newStatus) => {
    try {
      const response = await new Promise(resolve => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(err => resolve({ success: false, error: err.message }))
          .updateEstimateStatusWithSync({
            estimateId,
            newStatus,
            customerId: customer.customerId
          });
      });

      if (response.success) {
        showMessage(`Status updated to ${newStatus}`, 'success');
        loadEstimatesData();
      } else {
        showMessage(response.error || 'Failed to update status', 'error');
      }
    } catch (error) {
      showMessage('Failed to update status', 'error');
    }
  };

  const handleCreateNewVersion = async (estimate) => {
    try {
      const response = await new Promise(resolve => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(err => resolve({ success: false, error: err.message }))
          .createNewEstimateVersion({
            estimateId: estimate.estimateId,
            projectId: estimate.projectId,
            customerId: customer.customerId
          });
      });

      if (response.success) {
        showMessage('New version created successfully', 'success');
        loadEstimatesData();
      } else {
        showMessage(response.error || 'Failed to create new version', 'error');
      }
    } catch (error) {
      showMessage('Failed to create new version', 'error');
    }
  };

  const handleSendEmail = async (estimateId, emailData) => {
    try {
      const response = await new Promise(resolve => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(err => resolve({ success: false, error: err.message }))
          .sendEstimateEmail({
            estimateId,
            ...emailData
          });
      });

      if (response.success) {
        showMessage('Estimate sent successfully', 'success');
        loadEstimatesData();
      } else {
        showMessage(response.error || 'Failed to send estimate', 'error');
      }
    } catch (error) {
      showMessage('Failed to send estimate', 'error');
    }
  };

  // UI Components

  const StatusBadge = ({ status }) => {
    const statusColors = {
      DRAFT: 'bg-gray-100 text-gray-800',
      PENDING_REVIEW: 'bg-yellow-100 text-yellow-800',
      PENDING_CUSTOMER: 'bg-blue-100 text-blue-800',
      APPROVED: 'bg-green-100 text-green-800',
      REJECTED: 'bg-red-100 text-red-800',
      IN_PROGRESS: 'bg-purple-100 text-purple-800',
      COMPLETED: 'bg-teal-100 text-teal-800',
      CANCELLED: 'bg-gray-100 text-gray-800'
    };

    return (
      <span className={`px-2 py-1 rounded-full text-xs font-medium ${statusColors[status] || 'bg-gray-100'}`}>
        {status}
      </span>
    );
  };

  const EstimateActions = ({ estimate }) => {
    const canEdit = ['DRAFT', 'PENDING_REVIEW'].includes(estimate.status);
    const canCreateVersion = ['PENDING_CUSTOMER', 'REJECTED'].includes(estimate.status);
    const canApprove = estimate.status === 'PENDING_CUSTOMER';

    return (
      <div className="flex space-x-3">
        <button
          onClick={() => window.open(estimate.docUrl, '_blank')}
          className="text-blue-600 hover:text-blue-800"
        >
          View
        </button>
        {canEdit && (
          <button
            onClick={() => setIsEditing(true)}
            className="text-green-600 hover:text-green-800"
          >
            Edit
          </button>
        )}
        {canCreateVersion && (
          <button
            onClick={() => handleCreateNewVersion(estimate)}
            className="text-purple-600 hover:text-purple-800"
          >
            New Version
          </button>
        )}
        {canApprove && (
          <button
            onClick={() => handleStatusUpdate(estimate.estimateId, 'APPROVED')}
            className="text-green-600 hover:text-green-800"
          >
            Approve
          </button>
        )}
      </div>
    );
  };

  // Main render
  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-2xl font-bold text-gray-900">
            Estimates - {customer.name}
          </h2>
          <p className="text-sm text-gray-500">
            Customer ID: {customer.customerId}
          </p>
        </div>
        <button
          onClick={onBack}
          className="text-blue-600 hover:text-blue-800"
        >
          ‚Üê Back to Customer
        </button>
      </div>

      {/* Estimates List */}
      <div className="bg-white shadow rounded-lg overflow-hidden">
        <div className="px-4 py-5 border-b border-gray-200 sm:px-6">
          <div className="flex justify-between items-center">
            <h3 className="text-lg font-medium text-gray-900">
              Estimates
            </h3>
            <select
              value={filterStatus}
              onChange={(e) => setFilterStatus(e.target.value)}
              className="rounded-md border-gray-300 shadow-sm"
            >
              <option value="all">All Statuses</option>
              <option value="DRAFT">Draft</option>
              <option value="PENDING_REVIEW">Pending Review</option>
              <option value="PENDING_CUSTOMER">Pending Customer</option>
              <option value="APPROVED">Approved</option>
              <option value="IN_PROGRESS">In Progress</option>
              <option value="COMPLETED">Completed</option>
            </select>
          </div>
        </div>

        <div className="overflow-x-auto">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Estimate ID
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Version
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Status
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Amount
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Created
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {estimates.map((estimate) => (
                <tr key={estimate.estimateId} className="hover:bg-gray-50">
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center">
                      <div className="text-sm font-medium text-gray-900">
                        {estimate.estimateId}
                      </div>
                      {estimate.isActive && (
                        <span className="ml-2 px-2 py-1 text-xs font-medium text-green-800 bg-green-100 rounded-full">
                          Active
                        </span>
                      )}
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="text-sm text-gray-900">
                      v{estimate.versionNumber}
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <StatusBadge status={estimate.status} />
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="text-sm text-gray-900">
                      {new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD'
                      }).format(estimate.amount)}
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="text-sm text-gray-900">
                      {new Date(estimate.dateCreated).toLocaleDateString()}
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <EstimateActions estimate={estimate} />
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {/* Email Dialog */}
      {emailDialogOpen && selectedEstimate && (
        <EmailDialog
          estimate={selectedEstimate}
          onClose={() => setEmailDialogOpen(false)}
          onSend={handleSendEmail}
          customerEmail={customer.email}
        />
      )}
    </div>
  );
};

export default CustomerEstimatesManager;
</script>