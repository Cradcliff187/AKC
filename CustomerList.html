<script>
const CustomerList = ({
  customers,
  onSelectCustomer,
  onViewEstimates,
  onFilterChange,
  onSearch,
  showMessage
}) => {
  // Local state for filters
  const [searchTerm, setSearchTerm] = React.useState('');
  const [statusFilter, setStatusFilter] = React.useState('All');
  const [valueRangeFilter, setValueRangeFilter] = React.useState({
    min: null,
    max: null
  });

  // Handle filter changes
  const handleSearchChange = (e) => {
    const value = e.target.value;
    setSearchTerm(value);
    if (onSearch) onSearch(value);
  };

  const handleStatusChange = (e) => {
    const value = e.target.value;
    setStatusFilter(value);
    if (onFilterChange) {
      onFilterChange({ status: value, valueRange: valueRangeFilter });
    }
  };

  const handleValueRangeChange = (min, max) => {
    setValueRangeFilter({ min, max });
    if (onFilterChange) {
      onFilterChange({ status: statusFilter, valueRange: { min, max } });
    }
  };

  // Permission check function
  const hasPermission = (action) => {
    const userRole = window.CONSTANTS.USER_ROLE || 'CREATOR';
    const permissions = window.CONSTANTS.PERMISSIONS.CUSTOMER[action] || [];
    return permissions.includes(userRole);
  };

  // Status badge component
  const StatusBadge = ({ status, onStatusChange, disabled }) => {
    const config = CustomerStatusManager.getStatusConfig(status);
    const workflow = window.CONSTANTS.workflow.customerManagement;
    const transitions = workflow.transitions[status] || [];

    return React.createElement('div', { className: 'relative' }, [
      React.createElement('span', {
        className: `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
          bg-${config.color}-100 text-${config.color}-800`
      }, [
        React.createElement('span', {
          className: `mr-1 ${config.icon}`
        }),
        status
      ]),
      hasPermission('update') && !disabled && transitions.length > 0 && 
      React.createElement('select', {
        onChange: (e) => onStatusChange(e.target.value),
        className: 'ml-2 text-sm border rounded',
        value: ''
      }, [
        React.createElement('option', { value: '' }, 'Change Status'),
        ...transitions.map(newStatus =>
          React.createElement('option', { value: newStatus }, newStatus)
        )
      ])
    ]);
  };

  const handleViewDetails = (customer) => {
    if (!hasPermission('view')) {
      showMessage('Insufficient permissions to view customer details', 'error');
      return;
    }
    onSelectCustomer(customer);
  };

  const handleStatusChange = async (customerId, newStatus, currentStatus) => {
    if (!hasPermission('update')) {
      showMessage('Insufficient permissions to update status', 'error');
      return;
    }
  
    if (!CustomerStatusManager.validateTransition(currentStatus, newStatus)) {
      showMessage('Invalid status transition', 'error');
      return;
    }
  
    try {
      await google.script.run
        .withSuccessHandler(() => {
          showMessage('Status updated successfully', 'success');
          if (onFilterChange) {
            onFilterChange({ status: statusFilter, valueRange: valueRangeFilter });
          }
        })
        .withFailureHandler(error => {
          showMessage(error.message || 'Failed to update status', 'error');
        })
        .updateCustomerStatus({
          customerId,
          newStatus,
          currentStatus
        });
  
      await logCustomerActivity('STATUS_CHANGE', customerId, {
        oldStatus: currentStatus,
        newStatus
      });
    } catch (error) {
      showMessage('Failed to update status', 'error');
    }
  };

  return React.createElement('div', { className: 'space-y-4' }, [
    // Controls Section
    React.createElement('div', { 
      className: 'flex justify-between items-center bg-white p-4 rounded-lg shadow-sm'
    }, [
      // Search and Filters
      React.createElement('div', { className: 'flex space-x-4' }, [
        // Search Input
        React.createElement('input', {
          type: 'text',
          placeholder: 'Search customers...',
          value: searchTerm,
          onChange: handleSearchChange,
          className: 'p-2 border rounded-md'
        }),
        // Status Filter
        React.createElement('select', {
          value: statusFilter,
          onChange: handleStatusChange,
          className: 'p-2 border rounded-md'
        }, [
          React.createElement('option', { value: 'All' }, 'All Statuses'),
          Object.keys(window.CONSTANTS.CUSTOMER_STATUSES).map(status =>
            React.createElement('option', { 
              key: status, 
              value: status 
            }, status)
          )
        ])
      ])
    ]),

    // Customer Metrics
    React.createElement(CustomerMetrics, { customers }),

    // Customer Table
    React.createElement('div', { 
      className: 'bg-white shadow overflow-hidden sm:rounded-lg' 
    }, [
      React.createElement('table', { 
        className: 'min-w-full divide-y divide-gray-200' 
      }, [
        // Table Headers
        React.createElement('thead', { className: 'bg-gray-50' }, [
          React.createElement('tr', null, [
            'Customer ID',
            'Name',
            'Status',
            'Actions'
          ].map(header => 
            React.createElement('th', {
              key: header,
              className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase'
            }, header)
          ))
        ]),
        // Table Body
        React.createElement('tbody', { 
          className: 'bg-white divide-y divide-gray-200' 
        }, customers.map(customer => 
          React.createElement('tr', { key: customer.CustomerID }, [
            React.createElement('td', { className: 'px-6 py-4' }, 
              customer.CustomerID
            ),
            React.createElement('td', { className: 'px-6 py-4' }, 
              customer.CustomerName
            ),
            React.createElement('td', { className: 'px-6 py-4' },
              React.createElement(StatusBadge, {
                status: customer.Status,
                key: `status-${customer.CustomerID}`
              })
            ),
            React.createElement('td', { className: 'px-6 py-4' }, [
              React.createElement('button', {
                key: 'view',
                onClick: () => handleViewDetails(customer),
                className: 'text-blue-600 hover:text-blue-900 mr-4'
              }, 'View Details'),
              React.createElement('button', {
                key: 'estimates',
                onClick: () => onViewEstimates(customer),
                className: 'text-green-600 hover:text-green-900'
              }, 'Estimates')
            ])
          ])
        ))
      ])
    ])
  ]);
};

const CustomerStatusManager = {
  validateTransition: (currentStatus, newStatus) => {
    const workflow = window.CONSTANTS.workflow.customerManagement;
    return workflow.transitions[currentStatus]?.includes(newStatus);
  },

  getStatusConfig: (status) => {
    const workflow = window.CONSTANTS.workflow.customerManagement;
    return workflow.statusDisplay[status] || {
      color: 'gray',
      icon: 'circle'
    };
  }
};

const logCustomerActivity = async (action, customerId, details) => {
  await google.script.run
    .withFailureHandler(error => console.error('Activity log error:', error))
    .logActivity({
      action,
      moduleType: 'CUSTOMER',
      referenceId: customerId,
      details
    });
};

const CustomerMetrics = ({ customers }) => {
  const metrics = {
    total: customers.length,
    active: customers.filter(c => c.Status === 'ACTIVE').length,
    totalRevenue: customers.reduce((sum, c) => sum + (Number(c.TotalRevenue) || 0), 0)
  };

  return React.createElement('div', {
    className: 'grid grid-cols-3 gap-4 mb-6'
  }, [
    {
      label: 'Total Customers',
      value: metrics.total,
      color: 'blue'
    },
    {
      label: 'Active Customers',
      value: metrics.active,
      color: 'green'
    },
    {
      label: 'Total Revenue',
      value: new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
      }).format(metrics.totalRevenue),
      color: 'purple'
    }
  ].map(metric =>
    React.createElement('div', {
      key: metric.label,
      className: `bg-${metric.color}-50 p-4 rounded-lg`
    }, [
      React.createElement('div', {
        className: 'text-sm text-gray-600'
      }, metric.label),
      React.createElement('div', {
        className: `text-xl font-semibold text-${metric.color}-700`
      }, metric.value)
    ])
  ));
};

// Export for window
if (typeof window !== 'undefined') {
  window.CustomerList = CustomerList;
}

if (typeof this !== 'undefined') {
  this.CustomerList = CustomerList;
}
</script>