<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AKC Estimate Management</title>

  <!-- External Libraries -->
  <script src="https://unpkg.com/react@17.0.2/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@17.0.2/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

  <!-- Initialize AppState -->
  <script>
    // Initialize AppState globally
    window.AppState = {
      initialized: false,
      error: null,
      currentUser: null,
      lastUpdated: new Date().toISOString()
    };
    
    // Initialize or get client-side constants
    function initializeClientConstants() {
      // We need to wait for the server-side CONSTANTS to be loaded
      if (typeof CONSTANTS === 'undefined') {
        console.error('Server constants not loaded yet');
        return false;
      }
      
      // Make sure required properties exist
      if (!CONSTANTS.workflow) {
        console.error('CONSTANTS.workflow not found');
        return false;
      }
      
      if (!CONSTANTS.const STATUS_CONFIG = window.STATUS_CONFIG;) {
        console.error('CONSTANTS.const STATUS_CONFIG = window.STATUS_CONFIG; not found');
        return false;
      }
      
      // Set current user from session if available
      try {
        google.script.run
          .withSuccessHandler(function(user) {
            if (user && user.email) {
              window.AppState.currentUser = user;
              console.log('User loaded:', user.email);
            }
          })
          .withFailureHandler(function(error) {
            console.error('Failed to get user:', error);
          })
          .getCurrentUser();
      } catch (e) {
        console.error('Error getting current user:', e);
      }
      
      return true;
    }

    // Wait for DOMContentLoaded to initialize
    document.addEventListener('DOMContentLoaded', function() {
      // Try to initialize constants
      const initialized = initializeClientConstants();
      
      if (!initialized) {
        console.error('Failed to initialize client constants');
        
        // If CONSTANTS_LOADED event fires, try again
        window.addEventListener('constants_loaded', function() {
          console.log('Constants loaded, retrying initialization');
          initializeClientConstants();
        });
      }
    });
  </script>

  <!-- Load Constants and React libraries first -->
  <!-- Load in this specific order -->
  <?!= include('React'); ?>
  <?!= include('ReactDOM'); ?>
  <?!= include('Constants'); ?>
  <?!= include('SharedComponents'); ?>  <!-- Add this new line -->
  <?!= include('ComponentRegistry'); ?>
  
  <!-- Load Debug Tracer before ComponentRegistry -->
  <?!= include('test'); ?>
  
  <!-- Core Components - Include only once -->
  <?!= include('StatusBadge'); ?>
  <?!= include('MessageAlert'); ?>
  <?!= include('AddressInput'); ?>
  <?!= include('AddressValidator'); ?>

  <!-- Customer Components -->
  <?!= include('CustomerList'); ?>
  <?!= include('CustomerDetails'); ?>
  <?!= include('CustomerManagement'); ?>
  <?!= include('CustomerContacts'); ?>
  <?!= include('CustomerDocuments'); ?>
  <?!= include('CustomerEstimatesManager'); ?>
  <?!= include('CustomerProjects'); ?>
  <?!= include('CustomerCommunications'); ?>
  <?!= include('CustomerFinancials'); ?>
  <?!= include('CustomerDashboard'); ?>

  <!-- Project Components -->
  <?!= include('TimeLogger'); ?>
  <?!= include('MaterialsReceipt'); ?>
  <?!= include('SubInvoice'); ?>
  <?!= include('EstimateCreator'); ?>
  <?!= include('EstimateStatusManager'); ?>

  <!-- Loading styles -->
  <style>
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-message {
      padding: 1rem;
      margin: 1rem;
      background-color: #fee2e2;
      border: 1px solid #ef4444;
      border-radius: 0.375rem;
      color: #dc2626;
    }
  </style>

  <!-- Main Initialization Script -->
  <script>
    async function initializeApp() {
      console.log('Starting app initialization...');

      try {
        // Verify core dependencies
        const requiredDependencies = [
          'React', 'ReactDOM', 'CONSTANTS', 
          'ComponentRegistry', 'const validateCustomerData = window.validateCustomerData;'
        ];

        const missingDependencies = requiredDependencies.filter(
          dep => typeof window[dep] === 'undefined'
        );

        if (missingDependencies.length > 0) {
          throw new Error(`Missing dependencies: ${missingDependencies.join(', ')}`);
        }

        // Rest of your existing initialization logic...
      } catch (error) {
        console.error('Initialization error:', error);
        window.AppState.error = error.message;
        window.AppState.initialized = false;
        return false;
      }
    }

    // Main app component (React)
    const App = () => {
      const [currentView, setCurrentView] = React.useState('dashboard');
      const [selectedCustomer, setSelectedCustomer] = React.useState(null);

      if (!window.AppState.initialized) {
        return React.createElement('div', {
          className: 'error-message'
        }, `Application failed to initialize: ${window.AppState.error || 'Unknown error'}`);
      }

      return React.createElement('div', {
        className: 'container mx-auto p-4'
      }, [
        React.createElement('h1', {
          className: 'text-2xl font-bold mb-4'
        }, 'AKC LLC Management'),
        // Add main navigation and content here
        React.createElement('div', {
          className: 'py-4'
        }, 'Application successfully initialized!')
      ]);
    };

    // Initialize on DOM load
    document.addEventListener('DOMContentLoaded', async () => {
      const initialized = await initializeApp();
      
      if (initialized) {
        // Verify required components
        const requiredComponents = ['StatusBadge', 'MessageAlert'];
        const missingComponents = requiredComponents.filter(
          comp => !ComponentRegistry.get(comp)
        );
        
        if (missingComponents.length > 0) {
          console.error('Missing required components:', missingComponents);
          window.AppState.error = 'Missing required components: ' + missingComponents.join(', ');
          window.AppState.initialized = false;
        }
        
        ReactDOM.render(
          React.createElement(App),
          document.getElementById('root')
        );
      }
    });
  </script>

  <!-- Bootstrap dependencies -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>

<body>
  <!-- Alert container for MessageAlert component -->
  <div id="alert-container"></div>

  <!-- Main content container -->
  <div id="root">
    <!-- Loading spinner while app initializes -->
    <div class="flex items-center justify-center min-h-screen">
      <div class="loading-spinner"></div>
    </div>
  </div>
</body>
</html>