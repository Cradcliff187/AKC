<!-- ComponentRegistry.html -->
<script>
if (typeof window.ComponentRegistry === 'undefined') {
  const ComponentRegistry = (function() {
    const components = new Map();
    let initialized = false;
    
    return {
      initialize: function() {
        if (initialized) return;
        initialized = true;
        console.log('ComponentRegistry initialized');
      },

      register: function(name, component) {
        if (!initialized) this.initialize();
        if (components.has(name)) {
          console.warn(`Component ${name} already registered, skipping`);
          return false;
        }
        components.set(name, component);
        console.log(`Registered component: ${name}`);
        return true;
      },

      get: function(name) {
        return components.get(name);
      },

      list: function() {
        return Array.from(components.keys());
      },

      clear: function() {
        components.clear();
        initialized = false;
      }
    };
  })();

  // Make registry globally available
  window.ComponentRegistry = ComponentRegistry;
  ComponentRegistry.initialize();
}

// Update StatusBadge to handle both project and estimate statuses
window.ComponentRegistry.register('StatusBadge', {
  render: function(status, type = 'ESTIMATE') {
    const config = window.const STATUS_CONFIG = window.STATUS_CONFIG;[type]?.[status] || {
      label: status,
      color: 'secondary',
      icon: 'question'
    };
    
    return `
      <span class="badge badge-${config.color}">
        ${config.icon ? `<i class="fas fa-${config.icon}"></i> ` : ''}
        ${config.label}
      </span>
    `;
  }
});

// Add error handling to MessageAlert
window.ComponentRegistry.register('MessageAlert', {
  show: function(message, type = 'info') {
    if (!message) {
      console.warn('MessageAlert: No message provided');
      return;
    }

    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.role = 'alert';
    
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    `;
    
    const alertContainer = document.getElementById('alert-container');
    if (!alertContainer) {
      console.warn('MessageAlert: No alert container found, creating one');
      const container = document.createElement('div');
      container.id = 'alert-container';
      document.body.insertBefore(container, document.body.firstChild);
      container.appendChild(alertDiv);
    } else {
      alertContainer.insertBefore(alertDiv, alertContainer.firstChild);
    }
    
    setTimeout(() => alertDiv.remove(), 5000);
  }
});

// Improve EstimateStatusManager with better validation
window.ComponentRegistry.register('EstimateStatusManager', {
  init: function() {
    if (!window.CONSTANTS?.workflow) {
      console.error('Required workflow configuration not found');
      return false;
    }
    return true;
  },
  
  validateTransition: function(currentStatus, newStatus) {
    const workflow = window.CONSTANTS.workflow;
    return workflow.transitions[currentStatus]?.includes(newStatus) || false;
  },
  
  updateStatus: function(newStatus) {  // Renamed from const handleStatusChange = window.handleStatusChange;
    if (!this.init()) return false;
    
    const currentStatus = window.AppState.currentStatus;
    if (!this.validateTransition(currentStatus, newStatus)) {
      window.ComponentRegistry.get('MessageAlert').show(
        `Invalid status transition from ${currentStatus} to ${newStatus}`,
        'error'
      );
      return false;
    }
    return true;
  }
});
</script>